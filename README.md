# AI 虚拟换装系统

一个基于 Google Gemini API 的智能虚拟换装系统，支持多种换装模式和体验码验证功能。

## 🚀 功能特点

### 🎨 多种换装模式
- **👔 基础试衣**：单张人像 + 单张服装，生成最基础的换装效果
- **🎨 多图融合**：多张服装图片融合到一张人像中，适合快速预览整体搭配
- **👕 分别试穿**：每张服装分别与人像合成，适合详细对比每件服装效果
- **🎭 多场景换装**：为每张人像融合所有服装，生成多张换装效果图

### 🔐 体验码验证系统
- **安全验证**：需要输入有效体验码才能使用功能
- **使用限制**：每个体验码支持生成10张图片
- **防滥用机制**：基于哈希的持久化统计，防止用户绕过限制
- **隐私保护**：使用哈希值存储统计信息，不泄露原始验证码

### 🖼️ 图像处理功能
- **多格式支持**：支持JPG、PNG、JPEG格式
- **自动方向修复**：自动修复图片的EXIF方向信息
- **格式转换**：自动处理RGBA到RGB的转换
- **批量处理**：支持多张图片同时上传和处理

### 🎯 智能AI合成
- **高质量合成**：基于Google Gemini AI技术
- **自然融合**：保持人物身份和比例，自然融合服装
- **光影匹配**：自动调整服装的光影效果匹配人物
- **重试机制**：内置API调用重试机制，提高成功率

## 📋 系统要求

- Python 3.7+
- Google Gemini API 密钥
- 网络连接
- 现代浏览器（支持Streamlit）

## 🛠️ 安装步骤

### 1. 克隆项目
```bash
git clone <repository-url>
cd nano_fun
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置API密钥和体验码
在 `.streamlit/secrets.toml` 文件中配置：

```toml
# API配置
GEMINI_API_KEY = "your_api_key_here"

# 服装合成提示文本
clothing_prompt = "your_prompt_here"

# 体验码配置
[experience_codes]
your_experience_code_1 = { name = "体验码001", max_images = 10, description = "随机体验码1" }
# 可以添加更多体验码...
```

### 4. 启动应用
```bash
streamlit run app.py
```

## 🎯 使用方法

### Web界面使用

1. **输入体验码**
   - 打开浏览器访问应用
   - 输入有效的体验码进行验证

2. **上传图片**
   - 上传人像照片（支持多张）
   - 上传服装图片（支持多张）

3. **选择功能**
   - 系统会根据上传的图片数量自动显示相应功能
   - 选择你需要的换装模式

4. **生成效果**
   - 点击生成按钮
   - 等待AI处理完成
   - 查看和下载生成的换装效果


## 📁 项目结构

```
nano_fun/
├── app.py                      # 主Streamlit应用
├── image_generator.py          # 核心图像生成器类
├── requirements.txt            # Python依赖包
├── README.md                   # 项目说明文档
├── .streamlit/                 # Streamlit配置目录
│   └── secrets.toml           # 敏感配置（API密钥、体验码等）
```

## 🔧 核心组件说明

### ImageGenerator 类

主要的图像生成器类，提供以下方法：

#### `__init__(config_path='config.json')`
初始化图像生成器，从secrets.toml加载配置。

#### `generate(image_paths, output_path, custom_prompt=None)`
生成合成图像。

**参数：**
- `image_paths`: 图像路径列表，至少需要2个路径
- `output_path`: 输出图像路径（不包含扩展名）
- `custom_prompt`: 自定义提示文本（可选）

**返回值：**
- `bool`: 生成是否成功

## 📝 配置说明

### .streamlit/secrets.toml 配置项

| 配置项 | 类型 | 说明 | 必需 |
|--------|------|------|------|
| `GEMINI_API_KEY` | string | Google Gemini API密钥 | ✅ |
| `clothing_prompt` | string | 服装合成提示文本 | ✅ |
| `experience_codes` | table | 体验码配置表格 | ✅ |

### 体验码配置格式

```toml
[experience_codes]
验证码1 = { name = "体验码001", max_images = 10, description = "描述1" }
```

**配置说明：**
- `验证码1`：体验码字符串（小写字母+数字）
- `name`：显示名称
- `max_images`：最大生成图片数量
- `description`：描述信息

## 🎨 使用场景

1. **虚拟试衣**：在线试穿不同服装
2. **服装搭配**：预览多件服装的搭配效果
3. **批量试穿**：同时为多个人物试穿服装
4. **创意设计**：生成创意换装效果图
5. **电商展示**：为产品展示生成换装效果

## ⚠️ 注意事项

1. **API限制**：注意Google Gemini API的使用限制和配额
2. **体验码管理**：妥善保管体验码，避免泄露
3. **图像质量**：输入图像质量会影响最终合成效果
4. **网络连接**：需要稳定的网络连接访问API
5. **隐私保护**：使用统计基于哈希值，保护用户隐私

## 🐛 常见问题

### Q: 体验码验证失败
A: 请检查体验码是否正确，确保在secrets.toml中已正确配置。

### Q: 生成次数用完
A: 每个体验码限制10次生成，用完后需要更换新的体验码。

### Q: API调用失败
A: 请检查API密钥是否正确，网络连接是否正常，查看错误详情。

### Q: 图片上传失败
A: 请确保图片格式正确（JPG、PNG、JPEG），文件大小适中。

### Q: 生成效果不理想
A: 尝试使用更清晰的人像照片和服装图片，确保光线和角度合适。

## 🔒 安全特性

- **体验码哈希**：使用SHA256哈希值存储统计，保护原始验证码
- **持久化限制**：使用次数跨会话保持，防止滥用
- **配置隔离**：敏感配置存储在secrets.toml中，不提交到版本控制
- **错误处理**：完善的异常处理机制